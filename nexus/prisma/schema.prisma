// schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// RBAC ENUMS
// ============================================

/// Board-level role ‚Äî independent of org-level role.
/// Strict isolation: even org ADMIN/OWNER must be added as a BoardMember.
enum BoardRole {
  OWNER   // Full board control ‚Äî can delete, transfer, manage all members
  ADMIN   // Manage settings, members, automations, but not delete
  MEMBER  // Create/edit cards, comment
  VIEWER  // Read-only ‚Äî cannot create, edit, or delete anything
}

/// Granular permissions applied per BoardRole.
/// PermissionSchemes can override these defaults.
enum BoardPermission {
  // Board-level
  BOARD_VIEW
  BOARD_EDIT_SETTINGS
  BOARD_DELETE
  BOARD_SHARE
  BOARD_MANAGE_MEMBERS

  // List-level
  LIST_CREATE
  LIST_EDIT
  LIST_DELETE
  LIST_REORDER

  // Card-level
  CARD_CREATE
  CARD_VIEW
  CARD_EDIT
  CARD_DELETE
  CARD_MOVE
  CARD_ASSIGN
  CARD_COMMENT
  CARD_EDIT_OWN_COMMENT
  CARD_DELETE_OWN_COMMENT
  CARD_DELETE_ANY_COMMENT

  // Field visibility (Freelancer use case ‚Äî hide sensitive fields)
  FIELD_DESCRIPTION_VIEW
  FIELD_STORY_POINTS_VIEW
  FIELD_TIME_TRACKING_VIEW
  FIELD_ATTACHMENTS_VIEW
  FIELD_CUSTOM_FIELDS_VIEW

  // Automation & Analytics
  AUTOMATION_VIEW
  AUTOMATION_MANAGE
  ANALYTICS_VIEW
  ANALYTICS_EXPORT
}

/// Org membership lifecycle states.
/// New members start as PENDING ‚Äî quarantined until an org admin approves.
enum MembershipStatus {
  PENDING    // Awaiting admin approval ‚Äî cannot access any org data
  ACTIVE     // Full org access (still gated per board)
  SUSPENDED  // Manually revoked ‚Äî equivalent to removal
}

/// State machine for board/org access requests (dual-gate approval).
enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
  WITHDRAWN
}

/// Distinguishes org-level join requests from board-level access requests.
enum MembershipRequestType {
  ORG_MEMBERSHIP  // Gate 1: request to join the org
  BOARD_ACCESS    // Gate 2: request access to a specific board
}

// ============================================
// ORGANIZATION & USER MODELS
// ============================================

model Organization {
  id         String   @id @default(uuid())
  name       String
  slug       String   @unique
  imageUrl   String?

  // Regional data residency
  region     String   @default("eu-west")

  // Soft-delete support
  deletedAt  DateTime? @map("deleted_at")

  // Stripe Billing Fields
  subscriptionPlan        String   @default("FREE") @map("subscription_plan") // FREE or PRO
  stripeCustomerId        String?  @unique @map("stripe_customer_id")
  stripeSubscriptionId    String?  @unique @map("stripe_subscription_id")
  stripeSubscriptionStatus String? @map("stripe_subscription_status") // active, canceled, past_due, etc.
  stripePriceId           String?  @map("stripe_price_id")
  stripeCurrentPeriodEnd  DateTime? @map("stripe_current_period_end")

  boards            Board[]
  auditLogs         AuditLog[]
  members           OrganizationUser[]
  templates         BoardTemplate[]
  notifications     Notification[]
  webhooks          Webhook[]
  apiKeys           ApiKey[]
  automations       Automation[]
  savedViews        SavedView[]
  initiatives       Initiative[]
  epics             Epic[]
  customFields      CustomField[]
  boardShares       BoardShare[]
  permissionSchemes PermissionScheme[]
  membershipRequests MembershipRequest[]

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // AI rate limiting (TASK-022)
  aiCallsToday  Int       @default(0) @map("ai_calls_today")
  aiCallsResetAt DateTime? @map("ai_calls_reset_at")

  @@map("organizations")
}

model User {
  id             String   @id @default(uuid())
  clerkUserId    String   @unique @map("clerk_user_id")
  email          String   @unique
  name           String
  imageUrl       String?  @map("image_url")

  organizations  OrganizationUser[]
  assignedCards  Card[]   @relation("CardAssignee")
  preferences    UserPreference?

  // Notifications (TASK-006)
  notificationsReceived Notification[] @relation("NotificationRecipient")
  notificationsActed    Notification[] @relation("NotificationActor")

  // Time tracking (TASK-025)
  timeLogs       TimeLog[]

  // API Keys (TASK-021)
  apiKeys        ApiKey[]

  // Push subscription (TASK-029)
  pushSubscription String? @map("push_subscription") @db.Text

  // RBAC membership requests
  membershipRequests MembershipRequest[]

  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@map("users")
}

model OrganizationUser {
  id             String           @id @default(uuid())
  role           Role             @default(MEMBER)

  /// Org membership lifecycle state.
  /// ACTIVE  = can access the org (still gated per board).
  /// PENDING = quarantined until admin approves (Gate 1 of dual-gate).
  /// SUSPENDED = immediately revoked.
  /// DEFAULT: ACTIVE ‚Äî existing users are already active. New users provisioned
  /// via the healing path in getTenantContext also default to ACTIVE.
  /// Orgs that enable "require approval" set new members to PENDING explicitly.
  status         MembershipStatus @default(ACTIVE) @map("status")

  userId         String       @map("user_id")
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Membership lifecycle
  isActive       Boolean      @default(true)  @map("is_active")  // Legacy ‚Äî use status instead
  invitedById    String?      @map("invited_by_id")
  invitedAt      DateTime?    @map("invited_at")
  joinedAt       DateTime?    @map("joined_at")

  createdAt      DateTime     @default(now()) @map("created_at")

  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
  @@index([organizationId, status])
  @@map("organization_users")
}

enum Role {
  OWNER
  ADMIN
  MEMBER
  GUEST
}

// ============================================
// BOARD-LEVEL RBAC MODELS
// ============================================

/// Explicit board membership record.
/// A user must have a BoardMember row to access ANY board ‚Äî even org ADMIN/OWNER.
/// This enforces Strict Isolation (Zero-Trust, Principle of Least Privilege).
model BoardMember {
  id                 String            @id @default(uuid())
  boardId            String            @map("board_id")
  board              Board             @relation(fields: [boardId], references: [id], onDelete: Cascade)
  userId             String            @map("user_id")
  /// orgId denormalized from Board for cross-board member queries without double join.
  orgId              String            @map("org_id")
  role               BoardRole         @default(MEMBER)

  /// Per-member permission scheme override.
  /// When set, this scheme's entries override the board's default scheme for this specific member.
  /// Use case: grant a contractor VIEWER role but with a "Contractor" scheme that hides budget fields.
  permissionSchemeId String?           @map("permission_scheme_id")
  scheme             PermissionScheme? @relation(fields: [permissionSchemeId], references: [id])

  invitedBy          String?           @map("invited_by")   // userId of inviter
  invitedAt          DateTime          @default(now())      @map("invited_at")
  joinedAt           DateTime?         @map("joined_at")    // null until invitation accepted

  @@unique([boardId, userId])
  @@index([boardId])
  @@index([userId])
  @@index([orgId])
  @@map("board_members")
}

/// Named permission scheme ‚Äî a reusable template of role‚Üípermission grants.
/// Admins create schemes (e.g. "Freelancer", "Auditor") and assign them to boards.
/// Boards can have one scheme; individual members can override with a different scheme.
model PermissionScheme {
  id          String   @id @default(uuid())
  orgId       String   @map("org_id")
  org         Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  name        String
  description String?  @db.Text
  /// When true, new boards created in this org inherit this scheme automatically.
  isDefault   Boolean  @default(false) @map("is_default")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt      @map("updated_at")

  entries     PermissionSchemeEntry[]
  boards      Board[]       @relation("BoardPermissionScheme")
  members     BoardMember[]

  @@index([orgId])
  @@map("permission_schemes")
}

/// A single permission grant or denial within a PermissionScheme.
/// granted=true  ‚Üí this role has this permission.
/// granted=false ‚Üí this role is explicitly denied this permission (overrides default).
model PermissionSchemeEntry {
  id         String           @id @default(uuid())
  schemeId   String           @map("scheme_id")
  scheme     PermissionScheme @relation(fields: [schemeId], references: [id], onDelete: Cascade)
  role       BoardRole
  permission BoardPermission
  granted    Boolean          @default(true)

  @@unique([schemeId, role, permission])
  @@index([schemeId, role])
  @@map("permission_scheme_entries")
}

/// Dual-gate access request model.
/// Gate 1 ‚Äî ORG_MEMBERSHIP: user requests to join the org (status starts PENDING).
/// Gate 2 ‚Äî BOARD_ACCESS: org member requests access to a specific board.
model MembershipRequest {
  id            String                @id @default(uuid())
  orgId         String                @map("org_id")
  organization  Organization          @relation(fields: [orgId], references: [id], onDelete: Cascade)
  userId        String                @map("user_id")
  user          User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  type          MembershipRequestType
  boardId       String?               @map("board_id")    // Null for org requests
  board         Board?                @relation(fields: [boardId], references: [id], onDelete: Cascade)
  requestedRole BoardRole             @default(MEMBER)    @map("requested_role")
  status        RequestStatus         @default(PENDING)
  message       String?               @db.Text            // User's message to admin
  reviewedBy    String?               @map("reviewed_by") // userId of reviewing admin
  reviewedAt    DateTime?             @map("reviewed_at")
  reviewNote    String?               @db.Text            @map("review_note")
  expiresAt     DateTime?             @map("expires_at")  // Auto-expire after N days
  createdAt     DateTime              @default(now())     @map("created_at")

  @@index([orgId, status])
  @@index([userId])
  @@index([boardId, status])
  @@map("membership_requests")
}

// ============================================
// BOARD, LIST, CARD MODELS
// ============================================

model Board {
  id             String       @id @default(uuid())
  title          String

  // Unsplash Integration
  imageId        String?      @map("image_id")
  imageThumbUrl  String?      @map("image_thumb_url") @db.Text
  imageFullUrl   String?      @map("image_full_url") @db.Text
  imageUserName  String?      @map("image_user_name") @db.Text
  imageLinkHTML  String?      @map("image_link_html") @db.Text

  // Link to Organization for Multi-tenancy
  orgId          String       @map("org_id")
  organization   Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  /// Boards are private by default ‚Äî visible only to explicit BoardMembers.
  isPrivate      Boolean      @default(true) @map("is_private")

  /// Permission scheme governing this board's role‚Üípermission matrix.
  /// Null = use built-in default matrix from lib/board-permissions.ts.
  permissionSchemeId String?           @map("permission_scheme_id")
  permissionScheme   PermissionScheme? @relation("BoardPermissionScheme", fields: [permissionSchemeId], references: [id])

  members        BoardMember[]
  membershipRequests MembershipRequest[]
  lists          List[]
  analytics      BoardAnalytics?
  sprints        Sprint[]
  savedViews     SavedView[]
  customFields   CustomField[]
  automations    Automation[]
  shares         BoardShare[]
  epics          Epic[]

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([orgId])
  @@map("boards")
}

model List {
  id        String   @id @default(uuid())
  title     String

  // Lexorank: String-based ordering is mandatory for Senior roles
  order     String   @default("m")

  boardId   String   @map("board_id")
  board     Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)

  cards     Card[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([boardId])
  @@map("lists")
}

model Card {
  id          String    @id @default(uuid())
  title       String
  description String?   @db.Text

  // Lexorank: String-based ordering is mandatory for Senior roles
  order       String    @default("m")

  // Enhanced task management fields
  dueDate     DateTime? @map("due_date")
  priority    Priority  @default(MEDIUM)

  listId      String   @map("list_id")
  list        List     @relation(fields: [listId], references: [id], onDelete: Cascade)

  assigneeId  String?  @map("assignee_id")
  assignee    User?    @relation("CardAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)

  labels      CardLabelAssignment[]
  comments    Comment[]
  attachments Attachment[]
  checklists  Checklist[]
  timeLogs    TimeLog[]
  dependencies CardDependency[] @relation("BlockedCard")
  blocking     CardDependency[] @relation("BlockerCard")

  // Card Cover (TASK-010)
  coverColor    String?  @map("cover_color")
  coverImageUrl String?  @map("cover_image_url") @db.Text

  // Agile fields (TASK-013)
  sprintId      String?  @map("sprint_id")
  sprint        Sprint?  @relation(fields: [sprintId], references: [id], onDelete: SetNull)
  storyPoints   Int?     @map("story_points")
  startDate     DateTime? @map("start_date")

  // Roadmap/Epic link (TASK-023)
  epicId        String?  @map("epic_id")
  epic          Epic?    @relation(fields: [epicId], references: [id], onDelete: SetNull)

  // Time tracking (TASK-025)
  estimatedMinutes Int?  @map("estimated_minutes")

  // Custom field values (TASK-018)
  customFieldValues CustomFieldValue[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([listId])
  @@index([assigneeId])
  @@index([dueDate])
  @@index([priority])
  @@index([sprintId])
  @@index([epicId])
  @@map("cards")
}

// Labels are now reusable across cards (many-to-many)
model Label {
  id       String @id @default(uuid())
  name     String
  color    String @default("#6B7280")

  // Organization scoped for multi-tenancy
  orgId    String @map("org_id")

  cards    CardLabelAssignment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([orgId, name])
  @@index([orgId])
  @@map("labels")
}

// Join table for many-to-many Card <-> Label relationship
model CardLabelAssignment {
  id      String @id @default(uuid())

  cardId  String @map("card_id")
  card    Card   @relation(fields: [cardId], references: [id], onDelete: Cascade)

  labelId String @map("label_id")
  label   Label  @relation(fields: [labelId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([cardId, labelId])
  @@index([cardId])
  @@index([labelId])
  @@map("card_label_assignments")
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// ============================================
// COMMENTS & COLLABORATION
// ============================================

model Comment {
  id        String   @id @default(uuid())
  text      String   @db.Text // Rich text HTML from TipTap

  // Card relationship
  cardId    String   @map("card_id")
  card      Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)

  // User metadata (denormalized for performance)
  userId    String   @map("user_id")
  userName  String   @map("user_name")
  userImage String?  @map("user_image")

  // Threading support
  parentId  String?  @map("parent_id")
  parent    Comment? @relation("CommentThread", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[] @relation("CommentThread")

  // Social features
  reactions CommentReaction[]
  mentions  String[] // Array of mentioned user IDs

  // Draft support
  isDraft   Boolean  @default(false) @map("is_draft")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([cardId])
  @@index([userId])
  @@index([parentId])
  @@map("comments")
}

model CommentReaction {
  id        String   @id @default(uuid())
  emoji     String   // e.g., "üëç", "‚ù§Ô∏è", "üéâ"

  commentId String   @map("comment_id")
  comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)

  userId    String   @map("user_id")
  userName  String   @map("user_name")

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([commentId, userId, emoji]) // One reaction type per user per comment
  @@index([commentId])
  @@map("comment_reactions")
}

// ============================================
// AUDIT LOGGING
// ============================================

enum ENTITY_TYPE {
  BOARD
  LIST
  CARD
  ORGANIZATION
  // RBAC entities
  BOARD_MEMBER
  ORG_MEMBER
  PERMISSION_SCHEME
  API_KEY
  MEMBERSHIP_REQUEST
}

enum ACTION {
  CREATE
  UPDATE
  DELETE
  // Org membership lifecycle
  MEMBER_INVITED
  MEMBER_JOINED
  MEMBER_REMOVED
  MEMBER_ROLE_CHANGED
  MEMBER_STATUS_CHANGED
  // Board membership lifecycle
  BOARD_MEMBER_ADDED
  BOARD_MEMBER_REMOVED
  BOARD_MEMBER_ROLE_CHANGED
  // Permission management
  PERMISSION_SCHEME_CREATED
  PERMISSION_SCHEME_UPDATED
  PERMISSION_SCHEME_DELETED
  PERMISSION_SCHEME_ASSIGNED
  // Access requests (dual-gate)
  ACCESS_REQUESTED
  ACCESS_APPROVED
  ACCESS_REJECTED
  // Security forensics ‚Äî ALWAYS logged before throwing
  ACCESS_DENIED
  // API key lifecycle
  API_KEY_CREATED
  API_KEY_REVOKED
}

model AuditLog {
  id          String      @id @default(uuid())

  // Multi-tenant audit trail
  orgId       String      @map("org_id")
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  /// Board-scoped filtering ‚Äî allows admins to view a board's full activity history.
  boardId     String?     @map("board_id")

  action      ACTION
  entityId    String      @map("entity_id")
  entityType  ENTITY_TYPE @map("entity_type")
  entityTitle String      @map("entity_title")

  userId      String      @map("user_id")
  userImage   String      @db.Text @map("user_image")
  userName    String      @db.Text @map("user_name")

  // Request context for security forensics ‚Äî NOW populated
  ipAddress   String?     @map("ip_address")
  userAgent   String?     @map("user_agent")  @db.Text

  /// Serialised before-state for UPDATE/DELETE actions.
  /// Enables full forensic reconstruction of what changed and by whom.
  previousValues Json?    @map("previous_values")

  /// Serialised after-state for CREATE/UPDATE actions.
  newValues      Json?    @map("new_values")

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([orgId])
  @@index([userId])
  @@index([boardId])
  // Composite index for findManyForEntity (card modal audit log fetch)
  @@index([orgId, entityId, createdAt(sort: Desc)])
  @@map("audit_logs")
}

// ============================================
// ANALYTICS & REPORTING
// ============================================

model BoardAnalytics {
  id            String   @id @default(uuid())
  boardId       String   @unique @map("board_id")
  board         Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)

  // Snapshot data (updated daily)
  totalCards    Int      @default(0) @map("total_cards")
  completedCards Int     @default(0) @map("completed_cards")
  overdueCards  Int      @default(0) @map("overdue_cards")
  activeMembers Int      @default(0) @map("active_members")

  // Velocity metrics
  cardsCreatedToday    Int @default(0) @map("cards_created_today")
  cardsCompletedToday  Int @default(0) @map("cards_completed_today")
  avgCompletionTime    Int @default(0) @map("avg_completion_time") // in hours

  // Trend data (JSON for flexibility)
  weeklyTrends         Json? @map("weekly_trends") // {week1: {created: 10, completed: 8}, ...}
  priorityDistribution Json? @map("priority_distribution") // {urgent: 5, high: 10, medium: 15, low: 20}

  lastCalculated DateTime @updatedAt @map("last_calculated")
  createdAt      DateTime @default(now()) @map("created_at")

  @@index([boardId])
  @@index([lastCalculated])
  @@map("board_analytics")
}

model UserAnalytics {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  orgId        String   @map("org_id")

  // Daily snapshot
  date         DateTime @db.Date
  cardsCreated Int      @default(0) @map("cards_created")
  cardsCompleted Int    @default(0) @map("cards_completed")
  commentsAdded Int     @default(0) @map("comments_added")
  activeMinutes Int     @default(0) @map("active_minutes")

  // Metadata
  createdAt    DateTime @default(now()) @map("created_at")

  @@unique([userId, orgId, date])
  @@index([userId, date])
  @@index([orgId, date])
  @@map("user_analytics")
}

model ActivitySnapshot {
  id        String   @id @default(uuid())
  orgId     String   @map("org_id")
  timestamp DateTime @default(now())

  // Aggregate metrics (for timeline charts)
  activeUsers      Int @default(0) @map("active_users")
  totalBoards      Int @default(0) @map("total_boards")
  totalCards       Int @default(0) @map("total_cards")
  actionsPerformed Int @default(0) @map("actions_performed")

  @@index([orgId, timestamp])
  @@map("activity_snapshots")
}

model UserPreference {
  id                   String   @id @default(uuid())
  userId               String   @unique @map("user_id")
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Notification preferences
  emailNotifications   Boolean  @default(true)  @map("email_notifications")
  desktopNotifications Boolean  @default(false) @map("desktop_notifications")
  boardActivity        Boolean  @default(true)  @map("board_activity")
  cardComments         Boolean  @default(true)  @map("card_comments")
  cardDueDates         Boolean  @default(true)  @map("card_due_dates")
  weeklyDigest         Boolean  @default(false) @map("weekly_digest")

  // Workspace preferences
  autoSave             Boolean  @default(true)  @map("auto_save")
  compactMode          Boolean  @default(false) @map("compact_mode")
  showArchived         Boolean  @default(false) @map("show_archived")

  // Onboarding tracking (TASK-034)
  onboardingStep       Int      @default(0) @map("onboarding_step")
  onboardingCompleted  Boolean  @default(false) @map("onboarding_completed")

  // GDPR / Cookie consent (TASK-033)
  cookieConsent        String?  @map("cookie_consent") // "accepted" | "declined"

  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt      @map("updated_at")

  @@map("user_preferences")
}

// ============================================
// FILE ATTACHMENTS
// ============================================

model Attachment {
  id          String   @id @default(uuid())

  // File metadata
  fileName    String   @map("file_name")
  fileSize    Int      @map("file_size")   // bytes
  mimeType    String   @map("mime_type")

  // Storage URL (Supabase Storage)
  url         String   @db.Text
  storagePath String   @map("storage_path") @db.Text

  // Ownership
  cardId      String   @map("card_id")
  card        Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)

  uploadedById   String  @map("uploaded_by_id")
  uploadedByName String  @map("uploaded_by_name")

  createdAt   DateTime @default(now()) @map("created_at")

  @@index([cardId])
  @@map("attachments")
}

// ============================================
// BOARD TEMPLATES
// ============================================

model BoardTemplate {
  id          String   @id @default(uuid())

  title       String
  description String?  @db.Text
  category    String   @default("General") // e.g., Engineering, Marketing, Design

  // Template can be global (built-in) or org-specific
  orgId       String?  @map("org_id")
  org         Organization? @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Preview image (optional)
  imageThumbUrl String? @map("image_thumb_url") @db.Text

  lists       TemplateList[]

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt      @map("updated_at")

  @@index([orgId])
  @@map("board_templates")
}

model TemplateList {
  id         String        @id @default(uuid())
  title      String
  order      String        @default("m")

  templateId String        @map("template_id")
  template   BoardTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  cards      TemplateCard[]

  @@index([templateId])
  @@map("template_lists")
}

model TemplateCard {
  id         String       @id @default(uuid())
  title      String
  order      String       @default("m")

  listId     String       @map("list_id")
  list       TemplateList @relation(fields: [listId], references: [id], onDelete: Cascade)

  @@index([listId])
  @@map("template_cards")
}

// ============================================
// TASK-009: CARD CHECKLISTS
// ============================================

model Checklist {
  id        String          @id @default(uuid())
  cardId    String          @map("card_id")
  card      Card            @relation(fields: [cardId], references: [id], onDelete: Cascade)
  title     String          @default("Checklist")
  order     String          @default("m")
  items     ChecklistItem[]
  createdAt DateTime        @default(now()) @map("created_at")
  updatedAt DateTime        @updatedAt      @map("updated_at")

  @@index([cardId])
  @@map("checklists")
}

model ChecklistItem {
  id          String    @id @default(uuid())
  checklistId String    @map("checklist_id")
  checklist   Checklist @relation(fields: [checklistId], references: [id], onDelete: Cascade)
  title       String
  isComplete  Boolean   @default(false) @map("is_complete")
  order       String    @default("m")
  assigneeId  String?   @map("assignee_id")
  dueDate     DateTime? @map("due_date")
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt      @map("updated_at")

  @@index([checklistId])
  @@map("checklist_items")
}

// ============================================
// TASK-013: SPRINTS
// ============================================

enum SprintStatus {
  PLANNING
  ACTIVE
  COMPLETED
}

model Sprint {
  id          String       @id @default(uuid())
  boardId     String       @map("board_id")
  board       Board        @relation(fields: [boardId], references: [id], onDelete: Cascade)
  name        String
  goal        String?      @db.Text
  status      SprintStatus @default(PLANNING)
  startDate   DateTime?    @map("start_date")
  endDate     DateTime?    @map("end_date")
  completedAt DateTime?    @map("completed_at")
  cards       Card[]
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt      @map("updated_at")

  @@index([boardId])
  @@map("sprints")
}

// ============================================
// TASK-014: CARD DEPENDENCIES
// ============================================

enum DependencyType {
  BLOCKS
  RELATES_TO
  DUPLICATES
}

model CardDependency {
  id        String         @id @default(uuid())
  blockerId String         @map("blocker_id")
  blocker   Card           @relation("BlockerCard", fields: [blockerId], references: [id], onDelete: Cascade)
  blockedId String         @map("blocked_id")
  blocked   Card           @relation("BlockedCard", fields: [blockedId], references: [id], onDelete: Cascade)
  type      DependencyType @default(BLOCKS)
  createdAt DateTime       @default(now()) @map("created_at")

  @@unique([blockerId, blockedId])
  @@index([blockerId])
  @@index([blockedId])
  @@map("card_dependencies")
}

// ============================================
// TASK-006 / TASK-032: IN-APP NOTIFICATIONS
// ============================================

enum NotificationType {
  MENTIONED
  ASSIGNED
  CARD_DUE_SOON
  CARD_OVERDUE
  COMMENT_ON_ASSIGNED_CARD
  BOARD_SHARED
  SPRINT_STARTED
  DEPENDENCY_RESOLVED
}

model Notification {
  id          String           @id @default(uuid())
  orgId       String           @map("org_id")
  org         Organization     @relation(fields: [orgId], references: [id], onDelete: Cascade)
  userId      String           @map("user_id")
  user        User             @relation("NotificationRecipient", fields: [userId], references: [id], onDelete: Cascade)
  type        NotificationType
  title       String
  body        String?          @db.Text
  entityType  String?          @map("entity_type")
  entityId    String?          @map("entity_id")
  entityTitle String?          @map("entity_title")
  actorId     String           @map("actor_id")
  actor       User             @relation("NotificationActor", fields: [actorId], references: [id], onDelete: Cascade)
  actorName   String           @map("actor_name")
  actorImage  String?          @map("actor_image")
  isRead      Boolean          @default(false) @map("is_read")
  createdAt   DateTime         @default(now()) @map("created_at")

  @@index([userId, isRead, createdAt])
  @@index([orgId])
  @@map("notifications")
}

// ============================================
// TASK-012: SAVED VIEWS / FILTERS
// ============================================

model SavedView {
  id        String       @id @default(uuid())
  orgId     String       @map("org_id")
  org       Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  boardId   String?      @map("board_id")
  board     Board?       @relation(fields: [boardId], references: [id], onDelete: Cascade)
  userId    String       @map("user_id")
  name      String
  filters   Json
  viewType  String       @default("kanban") @map("view_type")
  isShared  Boolean      @default(false)    @map("is_shared")
  createdAt DateTime     @default(now())    @map("created_at")
  updatedAt DateTime     @updatedAt         @map("updated_at")

  @@index([orgId])
  @@index([boardId])
  @@map("saved_views")
}

// ============================================
// TASK-018: CUSTOM FIELDS
// ============================================

enum CustomFieldType {
  TEXT
  NUMBER
  DATE
  CHECKBOX
  SELECT
  MULTI_SELECT
  URL
  EMAIL
  PHONE
}

model CustomField {
  id         String           @id @default(uuid())
  orgId      String           @map("org_id")
  org        Organization     @relation(fields: [orgId], references: [id], onDelete: Cascade)
  boardId    String?          @map("board_id")
  board      Board?           @relation(fields: [boardId], references: [id], onDelete: Cascade)
  name       String
  type       CustomFieldType
  options    Json?
  isRequired Boolean          @default(false) @map("is_required")
  order      Int              @default(0)
  values     CustomFieldValue[]
  createdAt  DateTime         @default(now()) @map("created_at")
  updatedAt  DateTime         @updatedAt      @map("updated_at")

  @@index([orgId])
  @@index([boardId])
  @@map("custom_fields")
}

model CustomFieldValue {
  id           String      @id @default(uuid())
  fieldId      String      @map("field_id")
  field        CustomField @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  cardId       String      @map("card_id")
  card         Card        @relation(fields: [cardId], references: [id], onDelete: Cascade)
  valueText    String?     @map("value_text") @db.Text
  valueNumber  Float?      @map("value_number")
  valueDate    DateTime?   @map("value_date")
  valueBoolean Boolean?    @map("value_boolean")
  valueOptions String[]    @map("value_options")
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt      @map("updated_at")

  @@unique([fieldId, cardId])
  @@index([cardId])
  @@map("custom_field_values")
}

// ============================================
// TASK-019: AUTOMATION ENGINE
// ============================================

model Automation {
  id         String          @id @default(uuid())
  orgId      String          @map("org_id")
  org        Organization    @relation(fields: [orgId], references: [id], onDelete: Cascade)
  boardId    String?         @map("board_id")
  board      Board?          @relation(fields: [boardId], references: [id], onDelete: Cascade)
  name       String
  isEnabled  Boolean         @default(true)  @map("is_enabled")
  trigger    Json
  conditions Json
  actions    Json
  runCount   Int             @default(0)     @map("run_count")
  lastRunAt  DateTime?       @map("last_run_at")
  logs       AutomationLog[]
  createdAt  DateTime        @default(now()) @map("created_at")
  updatedAt  DateTime        @updatedAt      @map("updated_at")

  @@index([orgId])
  @@index([boardId])
  @@map("automations")
}

model AutomationLog {
  id           String     @id @default(uuid())
  automationId String     @map("automation_id")
  automation   Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)
  cardId       String?    @map("card_id")
  success      Boolean
  error        String?    @db.Text
  ranAt        DateTime   @default(now()) @map("ran_at")

  @@index([automationId])
  @@map("automation_logs")
}

// ============================================
// TASK-020: OUTBOUND WEBHOOKS
// ============================================

model Webhook {
  id         String            @id @default(uuid())
  orgId      String            @map("org_id")
  org        Organization      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  url        String            @db.Text
  secret     String
  events     String[]
  isEnabled  Boolean           @default(true) @map("is_enabled")
  deliveries WebhookDelivery[]
  createdAt  DateTime          @default(now()) @map("created_at")
  updatedAt  DateTime          @updatedAt      @map("updated_at")

  @@index([orgId])
  @@map("webhooks")
}

model WebhookDelivery {
  id          String   @id @default(uuid())
  webhookId   String   @map("webhook_id")
  webhook     Webhook  @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  event       String
  payload     Json
  statusCode  Int?     @map("status_code")
  success     Boolean
  duration    Int?
  attemptedAt DateTime @default(now()) @map("attempted_at")

  @@index([webhookId])
  @@map("webhook_deliveries")
}

// ============================================
// TASK-021: PUBLIC REST API KEYS
// ============================================

model ApiKey {
  id         String       @id @default(uuid())
  orgId      String       @map("org_id")
  org        Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  userId     String       @map("user_id")
  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  name       String
  keyHash    String       @unique @map("key_hash")
  keyPrefix  String       @map("key_prefix")
  scopes     String[]
  lastUsedAt DateTime?    @map("last_used_at")
  expiresAt  DateTime?    @map("expires_at")
  revokedAt  DateTime?    @map("revoked_at")
  createdAt  DateTime     @default(now()) @map("created_at")

  @@index([orgId])
  @@index([userId])
  @@map("api_keys")
}

// ============================================
// TASK-025: TIME TRACKING
// ============================================

model TimeLog {
  id          String   @id @default(uuid())
  cardId      String   @map("card_id")
  card        Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)
  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  orgId       String   @map("org_id")
  minutes     Int
  description String?  @db.Text
  loggedAt    DateTime @default(now()) @map("logged_at")

  @@index([cardId])
  @@index([userId])
  @@index([orgId])
  @@map("time_logs")
}

// ============================================
// TASK-023: ROADMAP ‚Äî INITIATIVES & EPICS
// ============================================

model Initiative {
  id          String       @id @default(uuid())
  orgId       String       @map("org_id")
  org         Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  title       String
  description String?      @db.Text
  status      String       @default("ACTIVE")
  startDate   DateTime?    @map("start_date")
  endDate     DateTime?    @map("end_date")
  color       String?
  epics       Epic[]
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt      @map("updated_at")

  @@index([orgId])
  @@map("initiatives")
}

model Epic {
  id           String      @id @default(uuid())
  orgId        String      @map("org_id")
  org          Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  boardId      String?     @map("board_id")
  board        Board?      @relation(fields: [boardId], references: [id], onDelete: Cascade)
  initiativeId String?     @map("initiative_id")
  initiative   Initiative? @relation(fields: [initiativeId], references: [id], onDelete: SetNull)
  title        String
  description  String?     @db.Text
  status       String      @default("IN_PROGRESS")
  startDate    DateTime?   @map("start_date")
  dueDate      DateTime?   @map("due_date")
  color        String?
  cards        Card[]
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt      @map("updated_at")

  @@index([orgId])
  @@index([boardId])
  @@index([initiativeId])
  @@map("epics")
}

// ============================================
// TASK-030: BOARD SHARING & GUEST ACCESS
// ============================================

model BoardShare {
  id            String    @id @default(uuid())
  boardId       String    @map("board_id")
  board         Board     @relation(fields: [boardId], references: [id], onDelete: Cascade)
  orgId         String    @map("org_id")
  org           Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  token         String    @unique
  isActive      Boolean   @default(true) @map("is_active")
  allowComments Boolean   @default(false) @map("allow_comments")
  allowCopyCards Boolean  @default(false) @map("allow_copy_cards")
  passwordHash  String?   @map("password_hash")
  expiresAt     DateTime? @map("expires_at")
  viewCount     Int       @default(0) @map("view_count")
  createdBy     String    @map("created_by")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt      @map("updated_at")

  @@index([boardId])
  @@index([orgId])
  @@map("board_shares")
}
